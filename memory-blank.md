Y√™u c·∫ßu cho h·ªá th·ªëng:

1. ƒêƒÉng nh·∫≠p h·ªá th·ªëng

üéØ M·ª•c ti√™u

X√¢y d·ª±ng m·ªôt trang web cho ph√©p user ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.

üë• ƒê·ªëi t∆∞·ª£ng s·ª≠ d·ª•ng

‚Ä¢ C√°c member trong BU PSI

‚Ä¢ H·ªá th·ªëng cho ph√©p CRUD user

‚Ä¢ 2 lo·∫°i quy·ªÅn:

o USER (MEMBER)

o ADMIN

üîß C√¥ng ngh·ªá & c√¥ng vi·ªác

‚Ä¢ T·∫°o Database

‚Ä¢ D·ª±ng project Spring Boot (Web), Java 8

‚Ä¢ Quy tr√¨nh: Study ‚Üí Estimate ‚Üí Development

2. M·ª•c ƒë√≠ch c·ªßa h·ªá th·ªëng

‚Ä¢ Ng∆∞·ªùi qu·∫£n l√Ω c√≥ th·ªÉ t·∫°o c√°c survey cho c√°c member trong BU th·ª±c hi·ªán.

‚Ä¢ Ng∆∞·ªùi qu·∫£n l√Ω c√≥ th·ªÉ xem c√°c survey ƒë√£ t·∫°o v√† b√°o c√°o th·ªëng k√™ k·∫øt qu·∫£ survey.

‚Ä¢ Member c√≥ th·ªÉ th·ª±c hi·ªán kh·∫£o s√°t tr√™n h·ªá th·ªëng.

3. Chi ti·∫øt y√™u c·∫ßu ch·ª©c nƒÉng

3.1 Ch·ª©c nƒÉng Qu·∫£n l√Ω Survey (ADMIN)

‚Ä¢ Xem danh s√°ch c√°c survey ƒë√£ t·∫°o.

‚Ä¢ T·∫°o m·ªõi v√† c·∫≠p nh·∫≠t survey.

‚Ä¢ Xem b√°o c√°o th·ªëng k√™ k·∫øt qu·∫£ survey c·ªßa member, bao g·ªìm th√¥ng tin chi ti·∫øt t·ª´ng

survey.

3.2 Ch·ª©c nƒÉng Survey (MEMBER)

‚Ä¢ Member ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng v√† th·ª±c hi·ªán survey ƒë∆∞·ª£c assign.

‚Ä¢ Ch·ªâ nh·ªØng member ƒë∆∞·ª£c ph√¢n c√¥ng m·ªõi th·ª±c hi·ªán ƒë∆∞·ª£c survey.

‚Ä¢ Survey ch·ªâ active trong th·ªùi gian ƒë√°nh gi√°.

4. Chi ti·∫øt ch·ª©c nƒÉng t·∫°o Survey

M·ªôt survey bao g·ªìm:

üîñ Th√¥ng tin Survey

‚Ä¢ Ti√™u ƒë·ªÅ

‚Ä¢ Th·ªùi gian th·ª±c hi·ªán

‚Ä¢ N·ªôi dung kh·∫£o s√°t

üóÇ C·∫•u tr√∫c n·ªôi dung Survey

N·ªôi dung ƒë∆∞·ª£c chia th√†nh:

‚Ä¢ Group(l√† group member. V√≠ d·ª• nh∆∞ group DEV, group PM, group BA...)

‚Ä¢ Question

‚Ä¢ Answer (Yes/No), text, option

- Survey c√≥ th·ªÉ g√°n member, ƒë·ªìng th·ªùi Group trong Survey c√≥ th·ªÉ g√°n cho t·∫•t c·∫£ ho·∫∑c 1 nh√≥m member ri√™ng. Vd survey kh·∫£o s√°t ch·∫•t l∆∞·ª£ng 2026 d√†nh cho all member, trong ƒë√≥ c√≥ 2 group question l√† quest_base (all member) v√† quest_leader(ch·ªâ d√†nh cho user role leader), v√≠ d·ª• nh∆∞ th·∫ø. Th√¨ survey ƒë√≥ s·∫Ω hi·ªÉn th·ªã cho all member nh∆∞ng v·ªõi user role leader m·ªõi hi·ªÉn th·ªã c√°c c√¢u h·ªèi trong quest_leader.

üîÅ T√°i s·ª≠ d·ª•ng group

‚Ä¢ M·ªôt survey c√≥ th·ªÉ c√≥ nhi·ªÅu group.

‚Ä¢ Group c√≥ th·ªÉ ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng ·ªü nhi·ªÅu survey kh√°c nhau.

üë• Ph√¢n c√¥ng member

‚Ä¢ M·ªói survey g√°n danh s√°ch member c·∫ßn th·ª±c hi·ªán.

‚Ä¢ M·ªôt s·ªë group c√≥ th·ªÉ g·∫Øn v·ªõi c√°c member kh√°c nhau.

‚úîÔ∏è Quy tr√¨nh ph√™ duy·ªát

Sau khi survey ƒë∆∞·ª£c t·∫°o:

1. PM review n·ªôi dung

2. PM confirm OK ‚Üí Survey m·ªõi ƒë∆∞·ª£c g·ª≠i cho member

3. Ch·ª©c nƒÉng th·ª±c hi·ªán Survey

‚Ä¢ Ch·ªâ member n·∫±m trong danh s√°ch m·ªõi ƒë∆∞·ª£c ph√©p l√†m survey.

‚Ä¢ Survey ch·ªâ kh·∫£ d·ª•ng (active) trong kho·∫£ng th·ªùi gian ƒë√°nh gi√°.

6. Report / B√°o c√°o

Y√™u c·∫ßu:

‚Ä¢ X√¢y d·ª±ng website cho BU qu·∫£n l√Ω survey.

‚Ä¢ Bao g·ªìm:

o Member login & th·ª±c hi·ªán kh·∫£o s√°t

o Admin qu·∫£n l√Ω survey v√† xem b√°o c√°o

- PM xem v√† APPROVE servey

‚Ä¢ C√¥ng vi·ªác:

o Ph√¢n t√≠ch y√™u c·∫ßu (Study + Q\&A)

o Thi·∫øt k·∫ø DB

o X√¢y d·ª±ng website b·∫±ng Spring Boot

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- USERS
CREATE TABLE users (
id BIGINT PRIMARY KEY,
username VARCHAR(50) NOT NULL UNIQUE,
password VARCHAR(255) NOT NULL,
full_name VARCHAR(100),
email VARCHAR(255),
status VARCHAR(20), -- ACTIVE/INACTIVE
created_at DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ROLES
CREATE TABLE roles (
id BIGINT PRIMARY KEY,
code VARCHAR(50) NOT NULL UNIQUE, -- ADMIN, MEMBER, LEADER, PM
name VARCHAR(100)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- USER_ROLE (many-to-many)
CREATE TABLE user_role (
user_id BIGINT NOT NULL,
role_id BIGINT NOT NULL,
PRIMARY KEY (user_id, role_id),
CONSTRAINT fk_ur_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
CONSTRAINT fk_ur_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY
CREATE TABLE survey (
id BIGINT PRIMARY KEY,
title VARCHAR(255) NOT NULL,
description TEXT,
start_date DATETIME,
end_date DATETIME,
status VARCHAR(20), -- DRAFT, PENDING, APPROVED, CLOSED
created_by BIGINT,
approved_by BIGINT,
approved_at DATETIME,
created_at DATETIME,
CONSTRAINT fk_s_created_by FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
CONSTRAINT fk_s_approved_by FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY ASSIGN RULE
CREATE TABLE survey_assign_rule (
id BIGINT PRIMARY KEY,
survey_id BIGINT NOT NULL,
rule_type VARCHAR(50) NOT NULL, -- ALL, ROLE, DEPARTMENT, GROUP
rule_value VARCHAR(100), -- MEMBER, LEADER, DEV, BA...
CONSTRAINT fk_sar_survey FOREIGN KEY (survey_id) REFERENCES survey(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- QUESTION GROUP (catalog)
CREATE TABLE question_group (
id BIGINT PRIMARY KEY,
code VARCHAR(100) NOT NULL UNIQUE, -- quest_base, quest_leader
name VARCHAR(255),
description TEXT,
target_role VARCHAR(50) -- NULL=ALL, LEADER, PM...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY_GROUP (map survey <-> question_group)
CREATE TABLE survey_group (
survey_id BIGINT NOT NULL,
group_id BIGINT NOT NULL,
PRIMARY KEY (survey_id, group_id),
CONSTRAINT fk_sg_survey FOREIGN KEY (survey_id) REFERENCES survey(id) ON DELETE CASCADE,
CONSTRAINT fk_sg_group FOREIGN KEY (group_id) REFERENCES question_group(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- QUESTION
CREATE TABLE question (
id BIGINT PRIMARY KEY,
group_id BIGINT NOT NULL,
content TEXT NOT NULL,
type VARCHAR(20), -- YES_NO, TEXT, OPTION
required TINYINT(1) DEFAULT 0,
order_index INT,
CONSTRAINT fk_q_group FOREIGN KEY (group_id) REFERENCES question_group(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- QUESTION OPTION
CREATE TABLE question_option (
id BIGINT PRIMARY KEY,
question_id BIGINT NOT NULL,
content VARCHAR(255) NOT NULL,
CONSTRAINT fk_qo_question FOREIGN KEY (question_id) REFERENCES question(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY_MEMBER (materialized assignees)
CREATE TABLE survey_member (
survey_id BIGINT NOT NULL,
user_id BIGINT NOT NULL,
assigned_at DATETIME,
PRIMARY KEY (survey_id, user_id),
CONSTRAINT fk_sm_survey FOREIGN KEY (survey_id) REFERENCES survey(id) ON DELETE CASCADE,
CONSTRAINT fk_sm_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY_SUBMISSION
CREATE TABLE survey_submission (
id BIGINT PRIMARY KEY,
survey_id BIGINT NOT NULL,
user_id BIGINT NOT NULL,
submitted_at DATETIME,
CONSTRAINT uq_submission UNIQUE (survey_id, user_id),
CONSTRAINT fk_ss_survey FOREIGN KEY (survey_id) REFERENCES survey(id) ON DELETE CASCADE,
CONSTRAINT fk_ss_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- SURVEY_ANSWER
CREATE TABLE survey_answer (
id BIGINT PRIMARY KEY AUTO_INCREMENT,
submission_id BIGINT NOT NULL,
question_id BIGINT NOT NULL,
answer_text TEXT,
option_id BIGINT,
CONSTRAINT fk_sa_submission FOREIGN KEY (submission_id) REFERENCES survey_submission(id) ON DELETE CASCADE,
CONSTRAINT fk_sa_question FOREIGN KEY (question_id) REFERENCES question(id) ON DELETE CASCADE,
CONSTRAINT fk_sa_option FOREIGN KEY (option_id) REFERENCES question_option(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

SET FOREIGN_KEY_CHECKS = 1;
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS=0;

-- ROLES
INSERT INTO `roles` (`id`,`code`,`name`) VALUES (1,'ADMIN','Qu·∫£n tr·ªã');
INSERT INTO `roles` (`id`,`code`,`name`) VALUES (2,'MEMBER','Th√†nh vi√™n');
INSERT INTO `roles` (`id`,`code`,`name`) VALUES (3,'LEADER','Tr∆∞·ªüng nh√≥m');
INSERT INTO `roles` (`id`,`code`,`name`) VALUES (4,'PM','Qu·∫£n l√Ω d·ª± √°n');

-- USERS
INSERT INTO `users` (`id`,`username`,`password`,`full_name`,`email`,`status`,`created_at`) VALUES
(1,'admin','$2a$10$hash_admin','Admin System','admin@example.com','ACTIVE','2025-12-01 09:00:00'),
(2,'pm1','$2a$10$hash_pm1','Phan Minh (PM)','pm1@example.com','ACTIVE','2025-12-01 09:10:00'),
(3,'leader1','$2a$10$hash_lead1','L√™ Duy (Leader)','leader1@example.com','ACTIVE','2025-12-05 10:00:00'),
(4,'member1','$2a$10$hash_mem1','Nguy·ªÖn An','member1@example.com','ACTIVE','2025-12-05 10:05:00'),
(5,'member2','$2a$10$hash_mem2','Tr·∫ßn B√¨nh','member2@example.com','ACTIVE','2025-12-05 10:06:00'),
(6,'member3','$2a$10$hash_mem3','Ph·∫°m Chi','member3@example.com','ACTIVE','2025-12-05 10:07:00'),
(7,'leader2','$2a$10$hash_lead2','V√µ D≈©ng (Leader)','leader2@example.com','ACTIVE','2025-12-06 09:00:00'),
(8,'member4','$2a$10$hash_mem4','ƒê·ªó Em','member4@example.com','ACTIVE','2025-05-01 09:00:00'),
(9,'member5','$2a$10$hash_mem5','Hu·ª≥nh Ph√°t','member5@example.com','ACTIVE','2025-05-01 09:05:00'),
(10,'qa_user','$2a$10$hash_qa','QA User','qa@example.com','INACTIVE','2025-05-01 09:10:00');

-- USER_ROLE
INSERT INTO `user_role` (`user_id`,`role_id`) VALUES
(1,1),(2,4),(3,3),(3,2),(4,2),(5,2),(6,2),(7,3),(7,2),(8,2),(9,2);

-- SURVEY
INSERT INTO `survey` (`id`,`title`,`description`,`start_date`,`end_date`,`status`,`created_by`,`approved_by`,`approved_at`,`created_at`) VALUES
(1,'Kh·∫£o s√°t h√†i l√≤ng Q1/2026','Survey to√†n c√¥ng ty v·ªÅ m√¥i tr∆∞·ªùng l√†m vi·ªác','2026-01-01 00:00:00','2026-02-15 23:59:59','APPROVED',1,2,'2025-12-28 09:00:00','2025-12-20 08:00:00'),
(2,'Kh·∫£o s√°t d√†nh cho Leader 2026','D√†nh ri√™ng cho c√°c Leader','2026-01-10 00:00:00','2026-02-10 23:59:59','APPROVED',1,2,'2026-01-05 10:00:00','2025-12-25 08:00:00'),
(3,'Kh·∫£o s√°t n·ªôi b·ªô 2025','ƒê·ª£t kh·∫£o s√°t 2025 ƒë√£ k·∫øt th√∫c','2025-06-01 00:00:00','2025-06-30 23:59:59','CLOSED',1,2,'2025-05-25 10:00:00','2025-05-20 08:00:00');

-- SURVEY_ASSIGN_RULE
INSERT INTO `survey_assign_rule` (`id`,`survey_id`,`rule_type`,`rule_value`) VALUES
(1,1,'ROLE','MEMBER'),
(2,1,'ROLE','LEADER'),
(3,2,'ROLE','LEADER'),
(4,3,'ALL',NULL);

-- QUESTION_GROUP
INSERT INTO `question_group` (`id`,`code`,`name`,`description`,`target_role`) VALUES
(1,'quest_base','B·ªô c√¢u h·ªèi chung','√Åp d·ª•ng cho t·∫•t c·∫£',NULL),
(2,'quest_leader','B·ªô c√¢u h·ªèi Leader','Ch·ªâ cho Leader','LEADER');

-- SURVEY_GROUP
INSERT INTO `survey_group` (`survey_id`,`group_id`) VALUES
(1,1),(1,2),(2,2),(3,1);

-- QUESTION
INSERT INTO `question` (`id`,`group_id`,`content`,`type`,`required`,`order_index`) VALUES
(1,1,'B·∫°n c√≥ h√†i l√≤ng v·ªõi m√¥i tr∆∞·ªùng l√†m vi·ªác?','YES_NO',1,1),
(2,1,'ƒêi·ªÅu g√¨ b·∫°n mu·ªën c·∫£i thi·ªán?','TEXT',0,2),
(3,1,'B·∫°n ƒë√°nh gi√° ph√∫c l·ª£i c√¥ng ty?','OPTION',1,3),
(4,2,'B·∫°n c√≥ th∆∞·ªùng xuy√™n feedback cho team?','YES_NO',1,1),
(5,2,'Kh√≥ khƒÉn l·ªõn nh·∫•t khi qu·∫£n l√Ω?','TEXT',0,2),
(6,2,'B·∫°n h√†i l√≤ng v·ªõi hi·ªáu su·∫•t team?','OPTION',1,3);

-- QUESTION_OPTION
INSERT INTO `question_option` (`id`,`question_id`,`content`) VALUES
(1,3,'T·ªët'),(2,3,'B√¨nh th∆∞·ªùng'),(3,3,'C·∫ßn c·∫£i thi·ªán'),
(4,6,'Cao'),(5,6,'Trung b√¨nh'),(6,6,'Th·∫•p');

-- SURVEY_MEMBER (materialized)
INSERT INTO `survey_member` (`survey_id`,`user_id`,`assigned_at`) VALUES
(1,3,'2025-12-29 09:00:00'),
(1,4,'2025-12-29 09:00:00'),
(1,5,'2025-12-29 09:00:00'),
(1,6,'2025-12-29 09:00:00'),
(1,7,'2025-12-29 09:00:00'),
(1,8,'2025-12-29 09:00:00'),
(1,9,'2025-12-29 09:00:00'),
(2,3,'2026-01-06 09:00:00'),
(2,7,'2026-01-06 09:00:00'),
(3,4,'2025-05-26 09:00:00'),
(3,8,'2025-05-26 09:00:00');

-- SURVEY_SUBMISSION (m·ªói user ch·ªâ submit 1 l·∫ßn/survey)
INSERT INTO `survey_submission` (`id`,`survey_id`,`user_id`,`submitted_at`) VALUES
(1,1,4,'2026-01-15 09:30:00'),
(2,1,5,'2026-01-16 10:00:00'),
(3,1,3,'2026-01-17 11:00:00'),
(4,1,7,'2026-01-18 14:45:00'),
(5,1,6,'2026-01-18 15:10:00'),
(6,2,3,'2026-01-18 16:00:00'),
(7,2,7,'2026-01-19 09:00:00'),
(8,3,4,'2025-06-10 08:30:00'),
(9,3,8,'2025-06-15 17:45:00');

-- SURVEY_ANSWER (YES/NO t√≠nh theo (submission_id + question_id) % 2, OPTION quay v√≤ng theo submission_id)
-- Survey 1 - member1 (submission 1, ch·ªâ quest_base)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(1,1,'YES',NULL),
(1,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(1,3,NULL,2);

-- Survey 1 - member2 (submission 2, ch·ªâ quest_base)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(2,1,'NO',NULL),
(2,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(2,3,NULL,3);

-- Survey 1 - leader1 (submission 3, quest_base + quest_leader)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(3,1,'YES',NULL),
(3,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(3,3,NULL,1),
(3,4,'NO',NULL),
(3,5,'Thi·∫øu th·ªùi gian mentoring cho member m·ªõi.',NULL),
(3,6,NULL,4);

-- Survey 1 - leader2 (submission 4, quest_base + quest_leader)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(4,1,'NO',NULL),
(4,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(4,3,NULL,2),
(4,4,'YES',NULL),
(4,5,'Thi·∫øu th·ªùi gian mentoring cho member m·ªõi.',NULL),
(4,6,NULL,5);

-- Survey 1 - member3 (submission 5, ch·ªâ quest_base)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(5,1,'YES',NULL),
(5,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(5,3,NULL,3);
-- Survey 2 - leader1 (submission 6, quest_leader)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(6,4,'YES',NULL),
(6,5,'Thi·∫øu th·ªùi gian mentoring cho member m·ªõi.',NULL),
(6,6,NULL,4);

-- Survey 2 - leader2 (submission 7, quest_leader)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(7,4,'NO',NULL),
(7,5,'Thi·∫øu th·ªùi gian mentoring cho member m·ªõi.',NULL),
(7,6,NULL,5);

-- Survey 3 - member1 (submission 8, quest_base)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(8,1,'NO',NULL),
(8,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(8,3,NULL,3);

-- Survey 3 - member4 (submission 9, quest_base)
INSERT INTO `survey_answer` (`submission_id`,`question_id`,`answer_text`,`option_id`) VALUES
(9,1,'YES',NULL),
(9,2,'T√¥i mu·ªën c·∫£i thi·ªán quy tr√¨nh review.',NULL),
(9,3,NULL,1);

SET FOREIGN_KEY_CHECKS=1;

---

-- SP: ph√™ duy·ªát survey v√† materialize survey_member t·∫°i th·ªùi ƒëi·ªÉm APPROVED
-- Y√™u c·∫ßu MySQL 8.x, engine InnoDB, schema ƒë√∫ng nh∆∞ ƒë√£ ƒë·ªãnh nghƒ©a tr∆∞·ªõc ƒë√≥.

---

DELIMITER $$

CREATE PROCEDURE sp_approve_survey (
IN p_survey_id BIGINT,
IN p_pm_id BIGINT
)
BEGIN
DECLARE v_status VARCHAR(20);
DECLARE v_cnt INT;

    -- B·∫Øt ƒë·∫ßu transaction (t·ª± ƒë√≥ng g√≥i trong SP)
    START TRANSACTION;

    -- 1) Kh√≥a b·∫£n ghi survey ƒë·ªÉ ch·ªëng race condition v√† ki·ªÉm tra tr·∫°ng th√°i
    SELECT status INTO v_status
    FROM survey
    WHERE id = p_survey_id
    FOR UPDATE;

    IF v_status IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Survey kh√¥ng t·ªìn t·∫°i';
    END IF;

    IF v_status <> 'PENDING' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Survey ph·∫£i ·ªü tr·∫°ng th√°i PENDING m·ªõi ƒë∆∞·ª£c approve';
    END IF;

    -- 2) Validate ƒëi·ªÅu ki·ªán nghi·ªáp v·ª• t·ªëi thi·ªÉu tr∆∞·ªõc khi approve
    SELECT COUNT(*) INTO v_cnt FROM survey_group WHERE survey_id = p_survey_id;
    IF v_cnt = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Survey ph·∫£i c√≥ √≠t nh·∫•t 1 question_group';
    END IF;

    SELECT COUNT(*) INTO v_cnt
    FROM question q
    JOIN survey_group sg ON sg.group_id = q.group_id
    WHERE sg.survey_id = p_survey_id;
    IF v_cnt = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Survey ph·∫£i c√≥ √≠t nh·∫•t 1 question';
    END IF;

    SELECT COUNT(*) INTO v_cnt FROM survey_assign_rule WHERE survey_id = p_survey_id;
    IF v_cnt = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Survey ph·∫£i c√≥ √≠t nh·∫•t 1 assign rule';
    END IF;

    -- 3) C·∫≠p nh·∫≠t tr·∫°ng th√°i sang APPROVED + ghi d·∫•u th·ªùi ƒëi·ªÉm/ng∆∞·ªùi duy·ªát
    UPDATE survey
    SET status = 'APPROVED',
        approved_at = NOW(),
        approved_by = p_pm_id
    WHERE id = p_survey_id;

    -- 4) (An to√†n) X√≥a d·ªØ li·ªáu materialized c≈© n·∫øu c√≥
    DELETE FROM survey_member WHERE survey_id = p_survey_id;

    -- 5) Materialize user th·ªèa rule v√†o survey_member (ch·ªâ l·∫•y user ACTIVE)
    --    H·ªó tr·ª£ 2 rule_type: ALL, ROLE. C√≥ th·ªÉ m·ªü r·ªông th√™m DEPARTMENT/GROUP sau.
    INSERT INTO survey_member (survey_id, user_id, assigned_at)
    SELECT p_survey_id, u.user_id, NOW()
    FROM (
        -- 5.1) ALL -> to√†n b·ªô user ACTIVE
        SELECT DISTINCT usr.id AS user_id
        FROM survey_assign_rule sar
        JOIN users usr ON usr.status = 'ACTIVE'
        WHERE sar.survey_id = p_survey_id
          AND sar.rule_type = 'ALL'

        UNION

-- 5.2) ROLE -> user c√≥ role t∆∞∆°ng ·ª©ng (ACTIVE)
SELECT DISTINCT usr.id AS user_idsp_approve_survey
FROM survey_assign_rule sar
JOIN roles r ON r.code = sar.rule_value
JOIN user_role ur ON ur.role_id = r.id
JOIN users usr ON usr.id = ur.user_id AND usr.status = 'ACTIVE'
WHERE sar.survey_id = p_survey_id
AND sar.rule_type = 'ROLE'

        -- (M·ªü r·ªông) UNION c√°c rule_type kh√°c n·∫øu c√≥:
        -- UNION
        -- SELECT DISTINCT usr.id
        -- FROM survey_assign_rule sar
        -- JOIN user_department ud ON ...
        -- WHERE sar.rule_type = 'DEPARTMENT' AND sar.rule_value = ud.dept_code
    ) AS u;

    -- 6) Commit n·∫øu m·ªçi b∆∞·ªõc ƒë·ªÅu OK
    COMMIT;

END$$

DELIMITER ;
SELECT \* FROM survey_member WHERE survey_id = 1 ORDER BY user_id;users

-- User load danh s√°ch survey th·∫•y ƒë∆∞·ª£c

SELECT s.\*
FROM survey s
JOIN survey_member sm
ON sm.survey_id = s.id
WHERE
sm.user_id = :currentUserId
AND s.status = 'APPROVED'
AND NOW() BETWEEN s.start_date AND s.end_date
AND NOT EXISTS (
SELECT 1
FROM survey_submission ss
WHERE ss.survey_id = s.id
AND ss.user_id = :currentUserId
)
ORDER BY s.start_date DESC;
